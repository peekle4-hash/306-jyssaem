<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ì¢Œì„í‘œ (5/5/5/4)</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{
      --bg:#f7f7fb; --card:#fff; --line:#e6e7ee; --text:#1f2330;
      --muted:#6b7280; --chip:#f1f5ff; --chipLine:#c9d6ff;
      --seat:#fff; --seatLine:#d9dde8;
      --okBg:#effdf2; --okLine:#86efac;
      --warnBg:#fff7ed; --warnLine:#fdba74;
      --dangerBg:#fff1f2; --dangerLine:#fda4af;
    }
    *,*::before,*::after{box-sizing:border-box;}
    html,body{margin:0;padding:0;
      font-family:system-ui,-apple-system,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      background:var(--bg);color:var(--text);}

    /* â•â• ê³µí†µ ì»´í¬ë„ŒíŠ¸ â•â• */
    .chip{
      user-select:none;-webkit-user-select:none;
      display:inline-flex;align-items:center;justify-content:center;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--chipLine);background:var(--chip);
      font-weight:800;cursor:grab;white-space:nowrap;
      touch-action:none;-webkit-touch-callout:none;
      min-width:0;
    }
    .chip:active{cursor:grabbing;}
    .chip.dragging{opacity:.4;}

    .seat{
      background:var(--seat);border:1.5px solid var(--seatLine);
      border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      padding:6px 10px;position:relative;touch-action:none;
      transition:background .12s,outline .1s;
    }
    .seat.over{background:#f0fff4;outline:2px solid #86efac;outline-offset:2px;}
    .seat[data-filled="false"]::after{
      content:"ë“œë¡­";position:absolute;bottom:5px;right:9px;
      font-size:10px;color:#c0c7d4;font-weight:800;
    }
    .seat-no{
      position:absolute;top:5px;left:9px;
      font-size:10px;color:#b0b8cc;font-weight:900;
      line-height:1;pointer-events:none;
    }
    .seat .chip{width:100%;justify-content:center;cursor:pointer;border:none;background:#eff6ff;}
    .seat .chip:hover{background:#fee2e2;}

    .cols{display:flex;justify-content:center;gap:10px;align-items:flex-end;margin:6px 0;}
    .col{display:flex;flex-direction:column;gap:10px;}

    .pill{
      display:inline-flex;align-items:center;
      padding:5px 10px;border-radius:999px;
      border:1px solid var(--line);background:#fff;
      font-size:12px;font-weight:800;white-space:nowrap;
    }
    .pill.ok    {background:var(--okBg);    border-color:var(--okLine);}
    .pill.warn  {background:var(--warnBg);  border-color:var(--warnLine);}
    .pill.danger{background:var(--dangerBg);border-color:var(--dangerLine);}

    button{
      border:1px solid var(--line);background:#fff;
      padding:9px 12px;border-radius:10px;cursor:pointer;
      font-weight:700;font-family:inherit;font-size:14px;
    }
    button:hover{filter:brightness(.97);}
    .dangerBtn{border-color:#ffd3d3;}
    .primaryBtn{border-color:#c7d2fe;background:#eef2ff;}

    .desk-bar{
      margin-top:12px;background:#0b1020;color:#fff;
      border-radius:14px;padding:12px;text-align:center;
      font-weight:900;letter-spacing:1px;
    }

    /* ë“œë˜ê·¸ ê³ ìŠ¤íŠ¸ */
    .drag-ghost{
      position:fixed;z-index:9999;pointer-events:none;
      border-radius:999px;padding:9px 16px;
      background:#4f46e5;color:#fff;font-weight:800;font-size:14px;
      white-space:nowrap;opacity:.88;
      box-shadow:0 6px 20px rgba(79,70,229,.35);
      transform:rotate(-2deg) scale(1.06);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PC ë ˆì´ì•„ì›ƒ (>760px)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .pc-wrap{
      max-width:1040px;margin:0 auto;padding:18px;
      display:grid;gap:14px;grid-template-columns:330px 1fr;
    }
    .panel,.stage{
      background:var(--card);border:1px solid var(--line);
      border-radius:14px;padding:14px;
    }
    h1{font-size:18px;margin:0 0 10px;}
    .hint{font-size:12px;color:var(--muted);margin:0 0 10px;line-height:1.5;}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .names{
      display:flex;flex-wrap:wrap;gap:8px;padding:10px;
      border:1px dashed var(--line);border-radius:12px;
      min-height:110px;background:#fafafe;
    }
    .stageHead{
      display:flex;align-items:flex-start;
      justify-content:space-between;gap:10px;margin-bottom:10px;
    }
    .meta{display:flex;gap:8px;flex-wrap:wrap;}
    .meta input{
      border:1px solid var(--line);border-radius:10px;
      padding:9px 12px;font-weight:700;min-width:170px;
      background:#fff;font-family:inherit;
    }
    .statusBox{
      margin:0 0 10px;padding:10px 12px;
      border-radius:12px;border:1px solid var(--line);background:#fff;
    }
    .statusRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .details{margin-top:8px;font-size:12px;color:var(--muted);line-height:1.5;word-break:keep-all;}
    .boardWrap{
      border:1px solid var(--line);border-radius:14px;
      background:#fbfbff;padding:14px;touch-action:none;
    }
    .pc-seat{width:132px;height:56px;}
    .small{font-size:12px;color:var(--muted);margin-top:8px;}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ (â‰¤760px)
       í™”ë©´ ì „ì²´ë¥¼ ê³ ì •, ë‚´ë¶€ë§Œ ìŠ¤í¬ë¡¤
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .mobile-wrap{display:none;}

    @media(max-width:760px){
      html,body{height:100%;overflow:hidden;}
      .pc-wrap{display:none!important;}
      .mobile-wrap{
        display:flex;flex-direction:column;
        height:100dvh;height:100vh; /* fallback */
        overflow:hidden;
      }
    }

    /* ìƒë‹¨ íˆ´ë°” */
    .m-topbar{
      flex-shrink:0;background:#fff;
      border-bottom:1px solid var(--line);
      padding:8px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    .m-topbar h2{font-size:15px;margin:0;font-weight:900;}
    .m-topbar-btns{display:flex;gap:6px;}
    .m-topbar-btns button{padding:8px 10px;font-size:12px;border-radius:8px;}

    /* ìƒíƒœë°” */
    .m-statusbar{
      flex-shrink:0;background:#fff;
      border-bottom:1px solid var(--line);
      padding:5px 10px;
      display:flex;gap:6px;align-items:center;
      overflow-x:auto;-webkit-overflow-scrolling:touch;
    }
    .m-details{
      flex-shrink:0;font-size:11px;color:var(--muted);
      padding:3px 12px 4px;background:#fafafe;
      border-bottom:1px solid var(--line);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }

    /* ì´ë¦„ íŒ”ë ˆíŠ¸: ê³ ì • ì˜ì—­, ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
    .m-palette{
      flex-shrink:0;
      padding:8px 10px 10px;
      background:#fafafe;
      border-bottom:2px solid #e2e8f0;
      max-height:28vh;overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }
    .m-palette-label{
      font-size:11px;font-weight:800;color:var(--muted);margin-bottom:6px;
    }
    .m-palette .names{
      min-height:unset;border:none;padding:0;background:transparent;gap:6px;
    }
    .m-palette .chip{font-size:13px;padding:7px 12px;}

    /* ì¢Œì„ ì˜ì—­: ë‚¨ì€ ê³µê°„ ì „ë¶€, ì„¸ë¡œë§Œ ìŠ¤í¬ë¡¤ */
    .m-seats{
      flex:1 1 0;
      overflow-x:hidden;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding:8px;background:var(--bg);
      touch-action:pan-y;
    }
    .m-seats.locking{overflow:hidden;touch-action:none;}

    .m-boardWrap{
      background:#fff;border:1px solid var(--line);
      border-radius:14px;
      padding:10px 6px 12px;
      width:100%;
    }

    /* 4ì—´ì´ í•­ìƒ í™”ë©´ ì•ˆì— ê½‰ ë§ë„ë¡: ê° ì—´ì´ flex:1ë¡œ ê· ë“± ë¶„ë°° */
    .m-boardWrap .cols{
      gap:6px;
      flex-wrap:nowrap;
      width:100%;
      justify-content:stretch;
      align-items:flex-end;
    }
    .m-boardWrap .col{ gap:8px; flex:1 1 0; min-width:0; }

    .m-seat{
      width:100%;
      min-width:0;
      height:52px;
    }
    .m-seat[data-filled="false"]::after{ display:none; }
    .m-seat .seat-no{ font-size:9px; }
    .m-seat .chip{
      font-size:clamp(11px, 3.2vw, 14px);
      padding:5px 4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }

    /* â•â• ëª¨ë“œ ì „í™˜ íƒ­ â•â• */
    .mode-tabs{
      display:flex;gap:0;margin-bottom:14px;
      border:1px solid var(--line);border-radius:12px;overflow:hidden;
    }
    .mode-tab{
      flex:1;padding:10px;text-align:center;cursor:pointer;
      font-weight:800;font-size:14px;background:#fff;
      border:none;border-radius:0;transition:background .15s,color .15s;
    }
    .mode-tab.active{background:#0b1020;color:#fff;}
    .mode-tab:first-child{border-right:1px solid var(--line);}

    /* â•â• ëª¨ë‘  ê·¸ë¦¬ë“œ â•â• */
    .group-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .group-card{
      border:2px solid var(--line);border-radius:14px;
      background:#fff;
      display:flex;flex-direction:column;
    }
    .group-header{
      padding:7px 12px;font-weight:900;font-size:13px;
      display:flex;align-items:center;justify-content:space-between;
      color:#fff;flex-shrink:0;border-radius:11px 11px 0 0;
    }
    .group-header .g-count{font-size:11px;opacity:.85;font-weight:700;}
    .group-body{
      padding:8px;
      display:flex;flex-wrap:wrap;gap:6px;align-content:flex-start;
      min-height:80px;
      touch-action:none;
      transition:background .12s;
    }
    .group-body.over{background:#f0fff4;outline:2px solid #86efac;outline-offset:-2px;}
    .group-body .chip{font-size:12px;padding:5px 10px;}
    .group-body .chip:hover{background:#fee2e2;}

    .names.over{background:#f0fff4;border:1.5px solid #86efac;}

    /* ëª¨ë‘  ìƒ‰ìƒ */
    .gc0{background:linear-gradient(135deg,#6366f1,#4f46e5);}
    .gc1{background:linear-gradient(135deg,#f59e0b,#d97706);}
    .gc2{background:linear-gradient(135deg,#10b981,#059669);}
    .gc3{background:linear-gradient(135deg,#ef4444,#dc2626);}
    .group-card.gc0{border-color:#c7d2fe;}
    .group-card.gc1{border-color:#fde68a;}
    .group-card.gc2{border-color:#a7f3d0;}
    .group-card.gc3{border-color:#fecaca;}

    .m-seat-wrap{
      display:flex;flex-direction:column;
      flex:1 1 0;overflow:hidden;
    }

    /* ëª¨ë‘  ëª¨ë“œ ìˆ¨ê¹€ */
    .seat-mode-content{display:block;}
    .group-mode-content{display:none;}
    body.group-mode .seat-mode-content{display:none;}
    body.group-mode .group-mode-content{display:block;}
    @media(max-width:760px){
      .m-seat-wrap.seat-mode-content{display:flex;flex-direction:column;}
      body.group-mode .group-mode-content{display:flex;flex-direction:column;flex:1 1 0;overflow-y:auto;}
      /* ëª¨ë°”ì¼: ëª¨ë‘  ê·¸ë¦¬ë“œë¥¼ í™”ë©´ì— ê½‰ ë§ê²Œ */
      .group-grid{ gap:8px; }
      .group-body{ min-height:50px; }
    }
  </style>
</head>
<body>

<!-- â”€â”€ PC ë ˆì´ì•„ì›ƒ â”€â”€ -->
<div class="pc-wrap">
  <section class="panel">
    <h1>í•™ìƒ ì´ë¦„í‘œ</h1>
    <p class="hint">ì´ë¦„í‘œë¥¼ <b>ì¢Œì„ì¹¸</b>ìœ¼ë¡œ ëŒì–´ë†“ìœ¼ë©´ ë°°ì¹˜ë©ë‹ˆë‹¤.<br>
      ì¢Œì„ì— ë“¤ì–´ê°„ ì´ë¦„í‘œëŠ” <b>ì§§ê²Œ íƒ­</b>í•˜ë©´ ë‹¤ì‹œ ì—¬ê¸°ë¡œ ëŒì•„ì˜µë‹ˆë‹¤.</p>
    <div id="pcPool" class="names"></div>
    <div class="toolbar">
      <button id="pcResetBtn" class="dangerBtn">ì „ì²´ ì´ˆê¸°í™”</button>
    </div>
    <p class="small">â€» ë²ˆí˜¸ëŠ” ê°€ë‚˜ë‹¤ìˆœ ê¸°ì¤€</p>
  </section>

  <section class="stage">
    <div class="stageHead">
      <div style="min-width:260px;">
        <h1 style="margin:0 0 8px;">ì¢Œì„í‘œ (ì™¼ìª½ë¶€í„° 5/5/4/4)</h1>
        <div class="meta">
          <input id="titleInput" placeholder="ì˜ˆ: 3-6 (2ì°¨ìë¦¬)" />
          <input id="dateInput"  placeholder="ì˜ˆ: 2026-03-05" />
        </div>
      </div>
      <div class="toolbar" style="margin:0;">
        <button id="pcExamBtn" class="primaryBtn">ğŸ“ ì‹œí—˜ ëŒ€í˜• ë°°ì¹˜</button>
        <button id="pcRandomSeatBtn" style="border-color:#e9d5ff;background:#faf5ff;">ğŸ² ëœë¤ ë°°ì¹˜</button>
        <button id="pcGroupBtn" style="border-color:#d1fae5;background:#ecfdf5;">ğŸ‘¥ ëª¨ë‘  êµ¬ì„±</button>
        <button id="pcSaveBtn" class="primaryBtn">PNG ì €ì¥</button>
      </div>
    </div>
    <div class="statusBox">
      <div class="statusRow" id="pcStatusRow"></div>
      <div class="details"   id="pcStatusDets"></div>
    </div>

    <!-- ì¢Œì„ ë°°ì¹˜ ëª¨ë“œ -->
    <div class="seat-mode-content">
      <div id="pcCapture" class="boardWrap">
        <div id="pcBoard"></div>
        <div class="desk-bar">êµíƒ</div>
      </div>
    </div>

    <!-- ëª¨ë‘  êµ¬ì„± ëª¨ë“œ -->
    <div class="group-mode-content">
      <div id="pcGroupCapture" class="boardWrap" style="padding:16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
          <span style="font-weight:900;font-size:15px;">ğŸ‘¥ ëª¨ë‘  êµ¬ì„±</span>
          <div style="display:flex;gap:8px;">
            <button id="pcRandomGroupBtn" style="border-color:#d1fae5;background:#ecfdf5;font-size:13px;padding:7px 12px;">ğŸ² ëœë¤ ë°°ì •</button>
            <button id="pcClearGroupBtn" class="dangerBtn" style="font-size:13px;padding:7px 12px;">ì „ì²´ ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div class="group-grid" id="pcGroupGrid"></div>
      </div>
    </div>
  </section>
</div>

<!-- â”€â”€ ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ â”€â”€ -->
<div class="mobile-wrap">
  <div class="m-topbar">
    <h2>ğŸª‘ 3-6 ìë¦¬ë°°ì¹˜</h2>
    <div class="m-topbar-btns">
      <button id="mResetBtn" class="dangerBtn">ì´ˆê¸°í™”</button>
      <button id="mExamBtn"  class="primaryBtn">ğŸ“ ì‹œí—˜ë°°ì¹˜</button>
      <button id="mRandomSeatBtn" style="border-color:#e9d5ff;background:#faf5ff;font-size:12px;padding:8px 10px;border-radius:8px;">ğŸ² ëœë¤</button>
      <button id="mGroupBtn" style="border-color:#d1fae5;background:#ecfdf5;font-size:12px;padding:8px 10px;border-radius:8px;">ğŸ‘¥ ëª¨ë‘ </button>
      <button id="mSaveBtn"  class="primaryBtn">ğŸ’¾ PNG</button>
    </div>
  </div>
  <div class="m-statusbar" id="mStatusBar"></div>
  <div class="m-details"   id="mDetails"></div>

  <!-- íŒ”ë ˆíŠ¸: ì¢Œì„/ëª¨ë‘  ëª¨ë“œ ê³µí†µ -->
  <div class="m-palette">
    <div class="m-palette-label">ğŸ“‹ ì´ë¦„í‘œë¥¼ ì•„ë˜ ìë¦¬ë¡œ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”</div>
    <div id="mPool" class="names"></div>
  </div>

  <!-- ëª¨ë°”ì¼ ì¢Œì„ ëª¨ë“œ -->
  <div class="seat-mode-content m-seat-wrap">
    <div class="m-seats" id="mSeats">
      <div class="m-boardWrap" id="mCapture">
        <div id="mBoard"></div>
        <div class="desk-bar">êµíƒ</div>
      </div>
    </div>
  </div>

  <!-- ëª¨ë°”ì¼ ëª¨ë‘  ëª¨ë“œ -->
  <div class="group-mode-content" id="mGroupCapture" style="padding:8px;background:var(--bg);">
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button id="mRandomGroupBtn" style="flex:1;border-color:#d1fae5;background:#ecfdf5;font-size:13px;">ğŸ² ëœë¤ ë°°ì •</button>
      <button id="mClearGroupBtn" class="dangerBtn" style="flex:1;font-size:13px;">ì „ì²´ ì´ˆê¸°í™”</button>
    </div>
    <div class="group-grid" id="mGroupGrid"></div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë°ì´í„° / ê³µìœ  ìƒíƒœ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GOOGLE_FORM_URL = "ì—¬ê¸°ì—_êµ¬ê¸€í¼_ì‘ë‹µë§í¬_ë¶™ì—¬ë„£ê¸°";

const students = [
  "ê¹€ì§€í›„","ë…¸ì§€ìŠ¹","ê³µì†Œì—°","ì–‘ì§€ë¯¼","ì˜¤ì‹œì€","ìš°ì„±ì•„","ìš°ì§€ë¯¼",
  "ìœ ì •ì¸","ìœ¤ì±„ì˜","ì´ì—°ìˆ˜","ì´ìœ¤ì•„","ì´ì§€ìš°","ì •ì±„ìœ¤","ì¡°ìˆ˜ì—°",
  "ìµœë¯¼ì§€","ìµœìˆ˜ë¹ˆ","í™©ì„¸ì¸","í™©ìœ ë¯¼",
  "ì•ˆë‹¤í˜„"
];
const COL_LAYOUT = [5,5,5,4];

function koSort(a,b){ return a.localeCompare(b,'ko'); }
const sorted = [...students].sort(koSort);

// 'ì•ˆë‹¤í˜„'ì€ ì‹ ê·œ í•™ìƒ(19ë²ˆ)ìœ¼ë¡œ ë§ˆì§€ë§‰ì— ê³ ì •
if (sorted.includes('ì•ˆë‹¤í˜„')) { sorted.splice(sorted.indexOf('ì•ˆë‹¤í˜„'),1); sorted.push('ì•ˆë‹¤í˜„'); }
const numOf  = new Map(sorted.map((n,i)=>[n,i+1]));
const disp   = n => `${numOf.get(n)||''}. ${n}`;

// seatId â†’ name | null
const seatIds = [];
COL_LAYOUT.forEach((cnt,c)=>{ for(let r=0;r<cnt;r++) seatIds.push(`${c}-${r}`); });
const seatMap = new Map(seatIds.map(id=>[id,null]));

/* â•â• ì¹© ìƒì„± â•â• */
function chip(name, onDown){
  const el = document.createElement('div');
  el.className = 'chip';
  el.textContent = disp(name);
  el.dataset.raw = name;
  el.addEventListener('pointerdown', onDown);
  return el;
}

/* â•â• ì¢Œì„ ê·¸ë¦¬ë“œ ìƒì„± â•â• */
function buildGrid(container, seatClass, onChipDown){
  container.innerHTML = '';
  const wrap = document.createElement('div');
  wrap.className = 'cols';
  // ê° ì—´ì˜ ì‹œì‘ ë²ˆí˜¸ ê³„ì‚° (ëˆ„ì  í•©)
  const colOffset = COL_LAYOUT.reduce((acc, cnt, i) => { acc[i] = (acc[i-1]||0) + (COL_LAYOUT[i-1]||0); return acc; }, []);
  COL_LAYOUT.forEach((cnt,c)=>{
    const col = document.createElement('div');
    col.className = 'col';
    for(let r=0;r<cnt;r++){
      // ë§¨ ì•„ë˜(r=cnt-1)ê°€ colOffset[c]+1, ìœ„ë¡œ ê°ˆìˆ˜ë¡ +1
      const seatNo = colOffset[c] + (cnt - r);
      const seat = document.createElement('div');
      seat.className = `seat ${seatClass}`;
      seat.dataset.seatId = `${c}-${r}`;
      seat.dataset.seatNo = seatNo;
      seat.dataset.filled = 'false';
      col.appendChild(seat);
    }
    wrap.appendChild(col);
  });
  container.appendChild(wrap);
  syncGrid(container, seatClass, onChipDown);
}

function syncGrid(container, seatClass, onChipDown){
  seatMap.forEach((name,id)=>{
    const seat = container.querySelector(`[data-seat-id="${id}"]`);
    if(!seat) return;
    seat.innerHTML = '';
    // ë²ˆí˜¸ í‘œì‹œ
    const noEl = document.createElement('span');
    noEl.className = 'seat-no';
    noEl.textContent = seat.dataset.seatNo;
    seat.appendChild(noEl);
    if(name){
      seat.dataset.filled = 'true';
      seat.appendChild(chip(name, onChipDown));
    } else {
      seat.dataset.filled = 'false';
    }
  });
}

function syncPool(pool, onDown){
  const placed = new Set([...seatMap.values()].filter(Boolean));
  pool.innerHTML = '';
  sorted.filter(n=>!placed.has(n)).forEach(n=>pool.appendChild(chip(n,onDown)));
}

/* â•â• ìƒíƒœ ì—…ë°ì´íŠ¸ â•â• */
function updateStatus(){
  const placed  = [...seatMap.values()].filter(Boolean);
  const unplaced = sorted.filter(n=>!placed.includes(n));

  const summary = unplaced.length ? `ë¯¸ë°°ì¹˜: ${unplaced.map(disp).join(', ')}` : 'âœ… ë¯¸ë°°ì¹˜ ì—†ìŒ';

  // PC
  const pr = document.getElementById('pcStatusRow');
  const pd = document.getElementById('pcStatusDets');
  if(pr){
    pr.innerHTML = '';
    [[`ë°°ì¹˜: ${placed.length}/${students.length}`,'ok'],
     [`ë¯¸ë°°ì¹˜: ${unplaced.length}`, unplaced.length?'warn':'ok'],
    ].forEach(([t,c])=>{ const p=document.createElement('span'); p.className=`pill ${c}`; p.textContent=t; pr.appendChild(p); });
    pd.textContent = summary;
  }
  // ëª¨ë°”ì¼
  const mb = document.getElementById('mStatusBar');
  const md = document.getElementById('mDetails');
  if(mb){
    mb.innerHTML = '';
    [[`ë°°ì¹˜ ${placed.length}/${students.length}`,'ok'],
     [`ë¯¸ë°°ì¹˜ ${unplaced.length}`, unplaced.length?'warn':'ok'],
    ].forEach(([t,c])=>{ const p=document.createElement('span'); p.className=`pill ${c}`; p.textContent=t; mb.appendChild(p); });
    md.textContent = summary;
  }
}

/* â•â• ë°°ì¹˜ ê³µí†µ ì²˜ë¦¬ â•â• */
function placeName(name, toSeatId){
  // ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì œê±°
  seatMap.forEach((v,k)=>{ if(v===name) seatMap.set(k,null); });
  seatMap.set(toSeatId, name);
}
function removeName(name){
  seatMap.forEach((v,k)=>{ if(v===name) seatMap.set(k,null); });
}

function fullSync(){
  buildGrid(document.getElementById('pcBoard'), 'pc-seat', makePCDown);
  syncPool(document.getElementById('pcPool'), makePCDown);
  buildGrid(document.getElementById('mBoard'), 'm-seat', makeMDown);
  syncPool(document.getElementById('mPool'), makeMDown);
  updateStatus();
}

function resetAll(){
  seatMap.forEach((_,k)=>seatMap.set(k,null));
  fullSync();
}

// ëœë¤ ë°°ì¹˜: í•™ìƒì„ ì¢Œì„ì— ë¬´ì‘ìœ„ ë°°ì •
function randomSeating(){
  seatMap.forEach((_,k)=>seatMap.set(k,null));
  const shuffled = [...sorted].sort(()=>Math.random()-.5);
  seatIds.forEach((id,i)=>{ if(i<shuffled.length) seatMap.set(id, shuffled[i]); });
  fullSync();
}
function examSeating(){
  // seatId â†’ seatNo ë§¤í•‘ ë¨¼ì € êµ¬ì¶• (buildGrid í˜¸ì¶œ ì „ì´ë¯€ë¡œ ì§ì ‘ ê³„ì‚°)
  seatMap.forEach((_,k)=>seatMap.set(k,null));
  const colOffset = COL_LAYOUT.reduce((acc, cnt, i) => { acc[i] = (acc[i-1]||0) + (COL_LAYOUT[i-1]||0); return acc; }, []);
  // seatNo â†’ seatId ì—­ë§¤í•‘
  const noToId = new Map();
  COL_LAYOUT.forEach((cnt,c)=>{
    for(let r=0;r<cnt;r++){
      const seatNo = colOffset[c] + (cnt - r);
      noToId.set(seatNo, `${c}-${r}`);
    }
  });
  // í•™ìƒ ë²ˆí˜¸(numOf) ê¸°ì¤€ìœ¼ë¡œ ë°°ì¹˜
  sorted.forEach(name=>{
    const no = numOf.get(name);
    const seatId = noToId.get(no);
    if(seatId !== undefined) seatMap.set(seatId, name);
  });
  fullSync();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë“œë˜ê·¸ ê³µí†µ ë¡œì§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startDrag({name, sourceChip, clientX, clientY, boardEl, poolEl, onCommit, onEnd}){
  // ê³ ìŠ¤íŠ¸
  const ghost = document.createElement('div');
  ghost.className = 'drag-ghost';
  ghost.textContent = disp(name);
  ghost.style.left = (clientX-40)+'px';
  ghost.style.top  = (clientY-22)+'px';
  document.body.appendChild(ghost);
  sourceChip.classList.add('dragging');

  let moved = false;
  const startX = clientX, startY = clientY;

  function move(cx, cy){
    const dx = cx-startX, dy = cy-startY;
    if(Math.abs(dx)+Math.abs(dy)>5) moved = true;
    ghost.style.left = (cx-40)+'px';
    ghost.style.top  = (cy-22)+'px';
    clearOver();
    const el = document.elementFromPoint(cx, cy);
    el?.closest?.('.seat')?.classList.add('over');
  }

  function up(cx, cy){
    clearOver();
    ghost.remove();
    sourceChip.classList.remove('dragging');
    onEnd?.();

    if(!moved){
      // íƒ­ â†’ ìë¦¬ì— ìˆìœ¼ë©´ ë°˜í™˜
      const fs = sourceChip.closest('.seat');
      if(fs){ seatMap.set(fs.dataset.seatId, null); onCommit(); }
      return;
    }
    const el = document.elementFromPoint(cx, cy);
    const seat = el?.closest?.('.seat');
    if(seat){
      const targetId = seat.dataset.seatId;
      const targetName = seatMap.get(targetId); // íƒ€ê²Ÿ ìë¦¬ì— ìˆëŠ” í•™ìƒ
      // ë“œë˜ê·¸í•œ í•™ìƒì˜ ì›ë˜ ìë¦¬ ì°¾ê¸°
      let sourceSeatId = null;
      seatMap.forEach((v,k)=>{ if(v===name) sourceSeatId=k; });
      if(targetName && sourceSeatId){
        // ë‘˜ ë‹¤ ìë¦¬ì— ìˆìœ¼ë©´ ìŠ¤ì™‘
        seatMap.set(sourceSeatId, targetName);
        seatMap.set(targetId, name);
      } else {
        placeName(name, targetId);
      }
      onCommit();
    } else if(el?.closest?.(`#${poolEl}`)){
      removeName(name);
      onCommit();
    }
  }

  function clearOver(){
    boardEl.querySelectorAll('.seat.over').forEach(s=>s.classList.remove('over'));
  }

  return { move, up };
}

/* â•â• PC ë“œë˜ê·¸ â•â• */
let pcDrag = null;
function makePCDown(e){
  const ch = e.currentTarget;
  ch.setPointerCapture(e.pointerId);
  const drag = startDrag({
    name: ch.dataset.raw,
    sourceChip: ch,
    clientX: e.clientX, clientY: e.clientY,
    boardEl: document.getElementById('pcBoard'),
    poolEl: 'pcPool',
    onCommit: ()=>{ syncGrid(document.getElementById('pcBoard'),'pc-seat',makePCDown); syncPool(document.getElementById('pcPool'),makePCDown); updateStatus(); },
    onEnd: ()=>{}
  });
  pcDrag = { id: e.pointerId, drag };
  window.addEventListener('pointermove', onPCMove, {passive:false});
  window.addEventListener('pointerup',   onPCUp,   {passive:false});
}
function onPCMove(e){ if(pcDrag&&e.pointerId===pcDrag.id){ e.preventDefault(); pcDrag.drag.move(e.clientX,e.clientY); } }
function onPCUp(e){
  if(!pcDrag||e.pointerId!==pcDrag.id) return;
  e.preventDefault();
  window.removeEventListener('pointermove',onPCMove);
  window.removeEventListener('pointerup',onPCUp);
  pcDrag.drag.up(e.clientX,e.clientY);
  pcDrag = null;
}

/* â•â• ëª¨ë°”ì¼ ë“œë˜ê·¸ â•â• */
let mDrag = null;
const mSeats = document.getElementById('mSeats');

function makeMDown(e){
  const ch = e.currentTarget;
  mSeats.classList.add('locking'); // ìŠ¤í¬ë¡¤ ì°¨ë‹¨
  const drag = startDrag({
    name: ch.dataset.raw,
    sourceChip: ch,
    clientX: e.clientX, clientY: e.clientY,
    boardEl: document.getElementById('mBoard'),
    poolEl: 'mPool',
    onCommit: ()=>{ syncGrid(document.getElementById('mBoard'),'m-seat',makeMDown); syncPool(document.getElementById('mPool'),makeMDown); updateStatus(); },
    onEnd: ()=>mSeats.classList.remove('locking')
  });
  mDrag = { id: e.pointerId, drag };
  window.addEventListener('pointermove', onMMove, {passive:false});
  window.addEventListener('pointerup',   onMUp,   {passive:false});
  window.addEventListener('pointercancel', onMCancel);
}
function onMMove(e){ if(mDrag&&e.pointerId===mDrag.id){ e.preventDefault(); mDrag.drag.move(e.clientX,e.clientY); } }
function onMUp(e){
  if(!mDrag||e.pointerId!==mDrag.id) return;
  e.preventDefault();
  window.removeEventListener('pointermove',onMMove);
  window.removeEventListener('pointerup',  onMUp);
  window.removeEventListener('pointercancel',onMCancel);
  mDrag.drag.up(e.clientX,e.clientY);
  mDrag = null;
}
function onMCancel(){
  mSeats.classList.remove('locking');
  window.removeEventListener('pointermove',onMMove);
  window.removeEventListener('pointerup',  onMUp);
  window.removeEventListener('pointercancel',onMCancel);
  mDrag = null;
  document.querySelector('.drag-ghost')?.remove();
}

/* â•â• PNG ì €ì¥ â•â• */
async function savePNG(){
  const isMobile = window.innerWidth <= 760;
  let cap;
  if(isGroupMode){
    cap = document.getElementById(isMobile ? 'mGroupCapture' : 'pcGroupCapture');
  } else {
    cap = document.getElementById(isMobile ? 'mCapture' : 'pcCapture');
  }
  const rawTitle = (document.getElementById('titleInput')?.value||'').trim();
  const rawDate  = (document.getElementById('dateInput')?.value ||'').trim();
  const cls   = rawTitle || '3-6';
  const today = new Date();
  const auto  = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  const date  = rawDate || auto;
  const match = cls.match(/\((.*?)\)/);
  const ver   = isGroupMode ? 'ëª¨ë‘ ë°°ì¹˜' : (match ? match[1].replace(/\s/g,'') : 'ìë¦¬ë°°ì¹˜');
  const clean = cls.replace(/\(.*?\)/,'').trim();
  const fname = `${clean}_${date}_${ver}.png`.replace(/[\\/:*?"<>|]/g,'_');

  const label = document.createElement('div');
  label.style.cssText='text-align:center;font-weight:900;margin-bottom:10px;padding:10px;border:1px solid #ddd;border-radius:12px;background:#fff;font-size:15px;';
  label.textContent = `${clean} | ${date} | ${ver}`;
  cap.prepend(label);

  const canvas = await html2canvas(cap,{scale:2,backgroundColor:'#ffffff'});
  label.remove();

  const a = document.createElement('a');
  a.download = fname; a.href = canvas.toDataURL('image/png'); a.click();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª¨ë‘  êµ¬ì„± ëª¨ë“œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GROUP_NAMES = ['1ëª¨ë‘ ','2ëª¨ë‘ ','3ëª¨ë‘ ','4ëª¨ë‘ '];
const GROUP_COLORS = ['gc0','gc1','gc2','gc3'];
const GROUP_MAX = 5; // ëª¨ë‘ ë‹¹ ìµœëŒ€ ì¸ì›
// groupMap: ëª¨ë‘ ë²ˆí˜¸(0~3) â†’ [ì´ë¦„, ...]
const groupMap = [[], [], [], []];

let isGroupMode = false;

function setGroupMode(on){
  isGroupMode = on;
  document.body.classList.toggle('group-mode', on);
  const hint = document.querySelector('.panel .hint');
  const mLabel = document.querySelector('.m-palette-label');
  if(on){
    if(hint) hint.innerHTML = 'ì´ë¦„í‘œë¥¼ <b>ëª¨ë‘  ë°•ìŠ¤</b>ë¡œ ëŒì–´ë†“ìœ¼ë©´ ë°°ì¹˜ë©ë‹ˆë‹¤.<br>ì´ë¦„ì„ <b>ì§§ê²Œ íƒ­</b>í•˜ë©´ ì—¬ê¸°ë¡œ ëŒì•„ì˜µë‹ˆë‹¤.';
    if(mLabel) mLabel.textContent = 'ğŸ“‹ ì´ë¦„í‘œë¥¼ ëª¨ë‘ ìœ¼ë¡œ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”';
    fullGroupSync();
  } else {
    if(hint) hint.innerHTML = 'ì´ë¦„í‘œë¥¼ <b>ì¢Œì„ì¹¸</b>ìœ¼ë¡œ ëŒì–´ë†“ìœ¼ë©´ ë°°ì¹˜ë©ë‹ˆë‹¤.<br>ì¢Œì„ì— ë“¤ì–´ê°„ ì´ë¦„í‘œëŠ” <b>ì§§ê²Œ íƒ­</b>í•˜ë©´ ë‹¤ì‹œ ì—¬ê¸°ë¡œ ëŒì•„ì˜µë‹ˆë‹¤.';
    if(mLabel) mLabel.textContent = 'ğŸ“‹ ì´ë¦„í‘œë¥¼ ì•„ë˜ ìë¦¬ë¡œ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”';
    syncPool(document.getElementById('pcPool'), makePCDown);
    syncPool(document.getElementById('mPool'), makeMDown);
  }
}

/* â”€â”€ ëª¨ë‘  ì¹© ìƒì„± â”€â”€ */
function gChip(name, onDown){
  const el = document.createElement('div');
  el.className = 'chip';
  el.textContent = disp(name);
  el.dataset.raw = name;
  el.addEventListener('pointerdown', onDown);
  return el;
}

/* â”€â”€ ëª¨ë‘  ê·¸ë¦¬ë“œ ë Œë”ë§ â”€â”€ */
function buildGroupGrid(gridEl, poolEl, isMobile){
  gridEl.innerHTML = '';
  GROUP_NAMES.forEach((gname, gi)=>{
    const card = document.createElement('div');
    card.className = `group-card ${GROUP_COLORS[gi]}`;

    const header = document.createElement('div');
    header.className = `group-header ${GROUP_COLORS[gi]}`;
    header.innerHTML = `<span>${gname}</span><span class="g-count">${groupMap[gi].length}ëª…</span>`;
    card.appendChild(header);

    const body = document.createElement('div');
    body.className = 'group-body';
    body.dataset.groupIdx = gi;
    groupMap[gi].forEach(name=>{
      body.appendChild(gChip(name, isMobile ? makeGMDown : makeGPCDown));
    });
    card.appendChild(body);
    gridEl.appendChild(card);
  });
}

function syncGroupPool(poolEl, isMobile){
  const placed = new Set(groupMap.flat());
  poolEl.innerHTML = '';
  sorted.filter(n=>!placed.has(n)).forEach(n=>{
    poolEl.appendChild(gChip(n, isMobile ? makeGMDown : makeGPCDown));
  });
}

function fullGroupSync(){
  buildGroupGrid(document.getElementById('pcGroupGrid'), document.getElementById('pcPool'), false);
  syncGroupPool(document.getElementById('pcPool'), false);
  buildGroupGrid(document.getElementById('mGroupGrid'), document.getElementById('mPool'), true);
  syncGroupPool(document.getElementById('mPool'), true);
}

/* â”€â”€ ëª¨ë‘ ì— ë°°ì¹˜ â”€â”€ */
function placeInGroup(name, toGroupIdx){
  // ê¸°ì¡´ ëª¨ë‘ ì—ì„œ ì œê±°
  groupMap.forEach(g=>{ const i=g.indexOf(name); if(i>-1) g.splice(i,1); });
  groupMap[toGroupIdx].push(name);
}
function removeFromGroup(name){
  groupMap.forEach(g=>{ const i=g.indexOf(name); if(i>-1) g.splice(i,1); });
}

/* â”€â”€ ëœë¤ ë°°ì • â”€â”€ */
function randomGroup(){
  // ì „ì²´ ì´ˆê¸°í™” í›„ ì„ì–´ì„œ ë°°ì •
  groupMap.forEach(g=>g.length=0);
  const shuffled = [...sorted].sort(()=>Math.random()-.5);
  shuffled.forEach((name,i)=>{ groupMap[i%4].push(name); });
  fullGroupSync();
}
function clearGroups(){
  groupMap.forEach(g=>g.length=0);
  fullGroupSync();
}

/* â”€â”€ ëª¨ë‘  ë“œë˜ê·¸ ê³µí†µ â”€â”€ */
function startGroupDrag({name, sourceChip, clientX, clientY, boardEl, poolEl, onCommit, onEnd}){
  const ghost = document.createElement('div');
  ghost.className = 'drag-ghost';
  ghost.textContent = disp(name);
  ghost.style.left = (clientX-40)+'px';
  ghost.style.top  = (clientY-22)+'px';
  document.body.appendChild(ghost);
  sourceChip.classList.add('dragging');

  let moved = false;
  const startX = clientX, startY = clientY;

  function move(cx,cy){
    if(Math.abs(cx-startX)+Math.abs(cy-startY)>5) moved=true;
    ghost.style.left=(cx-40)+'px'; ghost.style.top=(cy-22)+'px';
    document.querySelectorAll('.group-body.over,.names.over').forEach(e=>e.classList.remove('over'));
    const el=document.elementFromPoint(cx,cy);
    el?.closest?.('.group-body')?.classList.add('over');
    const maybePool=el?.closest?.(`#${poolEl}`);
    if(maybePool) maybePool.classList.add('over');
  }

  function up(cx,cy){
    document.querySelectorAll('.group-body.over,.names.over').forEach(e=>e.classList.remove('over'));
    ghost.remove();
    sourceChip.classList.remove('dragging');
    onEnd?.();

    if(!moved){
      // íƒ­ â†’ ëª¨ë‘ ì—ì„œ ì œê±° (poolë¡œ ë°˜í™˜)
      const fb = sourceChip.closest('.group-body');
      if(fb){ removeFromGroup(name); onCommit(); }
      return;
    }
    const el = document.elementFromPoint(cx,cy);
    const body = el?.closest?.('.group-body');
    const pool = el?.closest?.(`#${poolEl}`);
    if(body){
      placeInGroup(name, parseInt(body.dataset.groupIdx));
      onCommit();
    } else if(pool){
      removeFromGroup(name);
      onCommit();
    }
  }
  return {move,up};
}

/* â”€â”€ PC ëª¨ë‘  ë“œë˜ê·¸ â”€â”€ */
let gpcDrag=null;
function makeGPCDown(e){
  const ch=e.currentTarget;
  ch.setPointerCapture(e.pointerId);
  const boardEl = document.getElementById('pcGroupCapture');
  const drag=startGroupDrag({
    name:ch.dataset.raw, sourceChip:ch,
    clientX:e.clientX, clientY:e.clientY,
    boardEl, poolEl:'pcPool',
    onCommit:fullGroupSync, onEnd:()=>{}
  });
  gpcDrag={id:e.pointerId,drag};
  window.addEventListener('pointermove',onGPCMove,{passive:false});
  window.addEventListener('pointerup',  onGPCUp,  {passive:false});
}
function onGPCMove(e){if(gpcDrag&&e.pointerId===gpcDrag.id){e.preventDefault();gpcDrag.drag.move(e.clientX,e.clientY);}}
function onGPCUp(e){
  if(!gpcDrag||e.pointerId!==gpcDrag.id)return;
  e.preventDefault();
  window.removeEventListener('pointermove',onGPCMove);
  window.removeEventListener('pointerup',onGPCUp);
  gpcDrag.drag.up(e.clientX,e.clientY);
  gpcDrag=null;
}

/* â”€â”€ ëª¨ë°”ì¼ ëª¨ë‘  ë“œë˜ê·¸ â”€â”€ */
let gmDrag=null;
function makeGMDown(e){
  const ch=e.currentTarget;
  const boardEl=document.getElementById('mGroupGrid').closest('div');
  const drag=startGroupDrag({
    name:ch.dataset.raw, sourceChip:ch,
    clientX:e.clientX, clientY:e.clientY,
    boardEl, poolEl:'mPool',
    onCommit:fullGroupSync, onEnd:()=>{}
  });
  gmDrag={id:e.pointerId,drag};
  window.addEventListener('pointermove',onGMMove,{passive:false});
  window.addEventListener('pointerup',  onGMUp,  {passive:false});
}
function onGMMove(e){if(gmDrag&&e.pointerId===gmDrag.id){e.preventDefault();gmDrag.drag.move(e.clientX,e.clientY);}}
function onGMUp(e){
  if(!gmDrag||e.pointerId!==gmDrag.id)return;
  e.preventDefault();
  window.removeEventListener('pointermove',onGMMove);
  window.removeEventListener('pointerup',onGMUp);
  gmDrag.drag.up(e.clientX,e.clientY);
  gmDrag=null;
}

/* â•â• ë²„íŠ¼ ì´ë²¤íŠ¸ â•â• */
document.getElementById('pcResetBtn').addEventListener('click', resetAll);
document.getElementById('pcExamBtn').addEventListener('click', examSeating);
document.getElementById('pcRandomSeatBtn').addEventListener('click', randomSeating);
document.getElementById('pcGroupBtn').addEventListener('click', ()=>setGroupMode(true));
document.getElementById('pcSaveBtn').addEventListener('click',  savePNG);
document.getElementById('pcRandomGroupBtn').addEventListener('click', randomGroup);
document.getElementById('pcClearGroupBtn').addEventListener('click', clearGroups);

document.getElementById('mResetBtn').addEventListener('click', resetAll);
document.getElementById('mExamBtn').addEventListener('click', examSeating);
document.getElementById('mRandomSeatBtn').addEventListener('click', randomSeating);
document.getElementById('mGroupBtn').addEventListener('click', ()=>setGroupMode(true));
document.getElementById('mRandomGroupBtn').addEventListener('click', randomGroup);
document.getElementById('mClearGroupBtn').addEventListener('click', clearGroups);
document.getElementById('mSaveBtn').addEventListener('click',  savePNG);

// ì¢Œì„ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸°: pcExamBtn/pcResetBtn ìª½ì—ì„œ ëª¨ë“œ ë³µê·€
document.getElementById('pcExamBtn').addEventListener('click', ()=>setGroupMode(false), true);
document.getElementById('pcResetBtn').addEventListener('click', ()=>setGroupMode(false), true);
document.getElementById('mExamBtn').addEventListener('click', ()=>setGroupMode(false), true);
document.getElementById('mResetBtn').addEventListener('click', ()=>setGroupMode(false), true);

/* â•â• ì´ˆê¸°í™” â•â• */
fullSync();
</script>
</body>
</html>
